# VPN接続手順書（スマホ用）

このドキュメントでは、スマホ用Client VPNエンドポイント（証明書認証）への接続手順を説明します。

## 📋 目次

- [前提条件](#前提条件)
- [AWS VPN Clientのインストール](#aws-vpn-clientのインストール)
- [クライアント証明書の取得](#クライアント証明書の取得)
- [VPN接続の設定](#vpn接続の設定)
- [VPN接続の確立](#vpn接続の確立)
- [接続の確認](#接続の確認)
- [トラブルシューティング](#トラブルシューティング)

## 前提条件

### 必要なもの

- ✅ **スマートフォン**: iOS 12以降、またはAndroid 8.0以降
- ✅ **クライアント証明書**: インフラ管理者から提供される証明書ファイル
- ✅ **VPN設定ファイル**: `.ovpn`ファイル
- ✅ **インターネット接続**: VPNエンドポイントに接続できること

### 対応デバイス

- **iOS**: iPhone、iPad（iOS 12以降）
- **Android**: スマートフォン、タブレット（Android 8.0以降）

## AWS VPN Clientのインストール

### iOS (iPhone/iPad)

1. **App Store**を開く
2. 「**AWS VPN Client**」を検索
3. 「**入手**」をタップしてインストール
4. Face ID/Touch ID/パスコードで認証

### Android

1. **Google Play Store**を開く
2. 「**AWS VPN Client**」を検索
3. 「**インストール**」をタップ
4. 必要な権限を許可

## クライアント証明書の取得

### 証明書ファイルの受け取り

インフラ管理者から以下のファイルを受け取ります：

1. **クライアント証明書**: `client1.vpn.example.com.crt`
2. **クライアント秘密鍵**: `client1.vpn.example.com.key`
3. **CA証明書**: `ca.crt`
4. **VPN設定ファイル**: `mobile-vpn-config.ovpn`

⚠️ **セキュリティ注意**: これらのファイルは機密情報を含むため、以下の方法で安全に受け取ってください：

- ✅ **推奨**: セキュアなファイル共有サービス（Box、OneDrive、Google Drive）
- ✅ **推奨**: 暗号化されたメール
- ❌ **非推奨**: 平文のメール、SMS

### 証明書ファイルのスマホへの転送

#### 方法1: メールで転送（推奨）

1. PCで暗号化されたメールを開く
2. 添付ファイルをスマホのメールアプリで開く
3. 「共有」→「AWS VPN Clientで開く」を選択

#### 方法2: クラウドストレージ経由

1. PCでファイルをクラウドストレージ（OneDrive、Google Driveなど）にアップロード
2. スマホでクラウドストレージアプリを開く
3. ファイルをダウンロード
4. 「共有」→「AWS VPN Clientで開く」を選択

#### 方法3: AirDrop（iOS）/ Nearby Share（Android）

1. PCとスマホを近くに配置
2. AirDrop/Nearby Shareでファイルを転送
3. スマホで受信したファイルを開く

## VPN接続の設定

### iOS (iPhone/iPad)

#### ステップ1: AWS VPN Clientを起動

ホーム画面から「**AWS VPN Client**」アプリを起動します。

#### ステップ2: プロファイルの追加

1. 「**+**」ボタン（右上）をタップ

2. 「**Import .ovpn file**」を選択

3. ファイルアプリから`mobile-vpn-config.ovpn`を選択

4. プロファイル情報を確認：
   - **Display Name**: `Mobile VPN (Certificate)`（任意の名前）
   - **Server**: VPNエンドポイントのDNS名
   - **Authentication**: Certificate

5. 「**Add**」をタップ

#### ステップ3: 証明書のインポート

1. プロファイルをタップして詳細画面を開く

2. 「**Certificate**」セクションで「**Import Certificate**」をタップ

3. 以下のファイルを順番にインポート：
   - **Client Certificate**: `client1.vpn.example.com.crt`
   - **Client Key**: `client1.vpn.example.com.key`
   - **CA Certificate**: `ca.crt`

4. 各ファイルをインポート後、「**Done**」をタップ

#### ステップ4: VPN権限の許可

1. 「**Allow**」をタップしてVPN構成の追加を許可

2. Face ID/Touch ID/パスコードで認証

3. 「VPN構成を追加しようとしています」ダイアログで「**許可**」をタップ

### Android

#### ステップ1: AWS VPN Clientを起動

アプリドロワーから「**AWS VPN Client**」アプリを起動します。

#### ステップ2: プロファイルの追加

1. 「**+**」ボタン（右下）をタップ

2. 「**Import .ovpn file**」を選択

3. ファイルマネージャーから`mobile-vpn-config.ovpn`を選択

4. プロファイル情報を確認：
   - **Profile Name**: `Mobile VPN (Certificate)`（任意の名前）
   - **Server**: VPNエンドポイントのDNS名
   - **Authentication**: Certificate

5. 「**Import**」をタップ

#### ステップ3: 証明書のインポート

1. プロファイルをタップして詳細画面を開く

2. 「**Certificate**」セクションで「**Import Certificate**」をタップ

3. 以下のファイルを順番にインポート：
   - **Client Certificate**: `client1.vpn.example.com.crt`
   - **Client Key**: `client1.vpn.example.com.key`
   - **CA Certificate**: `ca.crt`

4. 各ファイルをインポート後、「**OK**」をタップ

#### ステップ4: VPN権限の許可

1. 「**OK**」をタップしてVPN接続リクエストを許可

2. 「接続リクエスト」ダイアログで「**OK**」をタップ

## VPN接続の確立

### iOS (iPhone/iPad)

1. AWS VPN Clientのメイン画面で「**Mobile VPN (Certificate)**」プロファイルを選択

2. 「**Connect**」ボタンをタップ

3. 接続中...（数秒待機）

4. ステータスバーにVPNアイコン（🔒）が表示されます

✅ **接続成功！**

### Android

1. AWS VPN Clientのメイン画面で「**Mobile VPN (Certificate)**」プロファイルを選択

2. 「**Connect**」ボタンをタップ

3. 接続中...（数秒待機）

4. 通知バーにVPNアイコン（🔑）が表示されます

✅ **接続成功！**

## 接続の確認

### 方法1: AWS VPN Clientで確認

AWS VPN Clientのメイン画面で以下を確認：

- **Status**: Connected（緑色）
- **IP Address**: 割り当てられたVPN IPアドレス（172.17.x.x）
- **Duration**: 接続時間
- **Data Transferred**: 送受信データ量

### 方法2: ブラウザで確認

スマホのブラウザで以下のサイトにアクセス：

- https://www.whatismyip.com/
- https://ipinfo.io/

表示されるIPアドレスが、NAT GatewayのElastic IPと一致することを確認してください。

### 方法3: 接続テスト

1. ブラウザで社内リソース（イントラネットなど）にアクセス
2. 正常にアクセスできることを確認

## VPN接続の切断

### iOS

1. AWS VPN Clientのメイン画面で「**Disconnect**」ボタンをタップ
2. ステータスバーのVPNアイコンが消えることを確認

### Android

1. AWS VPN Clientのメイン画面で「**Disconnect**」ボタンをタップ
2. 通知バーのVPNアイコンが消えることを確認

## 自動接続の設定（オプション）

### iOS

1. AWS VPN Clientで「**Settings**」（⚙️）をタップ
2. 「**Auto-connect**」をオンにする
3. プロファイルを選択：「**Mobile VPN (Certificate)**」

これで、Wi-Fi/モバイルデータ接続時に自動的にVPNに接続されます。

### Android

1. AWS VPN Clientで「**Settings**」（⚙️）をタップ
2. 「**Auto-connect**」をオンにする
3. プロファイルを選択：「**Mobile VPN (Certificate)**」

## バッテリー消費の最適化

VPN接続はバッテリーを消費します。以下の設定で最適化できます：

### iOS

1. 「**設定**」→「**バッテリー**」を開く
2. バッテリー使用状況で「AWS VPN Client」を確認
3. 必要ない時はVPN接続を切断

### Android

1. 「**設定**」→「**バッテリー**」を開く
2. 「**バッテリー使用量**」で「AWS VPN Client」を確認
3. 「**バッテリー最適化**」を有効にする（ただし、自動接続が無効になる場合があります）

## トラブルシューティング

### 問題1: 証明書のインポートに失敗する

**症状**: 「Invalid certificate」エラーが表示される

**解決方法**:
1. **証明書ファイルを確認**
   - ファイルが破損していないか確認
   - 正しいファイル（.crt、.key）を選択しているか確認
   
2. **証明書の有効期限を確認**
   - インフラ管理者に証明書の有効期限を確認
   
3. **証明書を再取得**
   - インフラ管理者から新しい証明書を取得

### 問題2: 接続が確立されない

**症状**: 「Connection failed」エラーが表示される

**解決方法**:
1. **インターネット接続を確認**
   - Wi-Fiまたはモバイルデータが有効か確認
   - 他のWebサイトにアクセスできるか確認
   
2. **証明書を確認**
   - クライアント証明書が正しくインポートされているか確認
   - 証明書の有効期限が切れていないか確認
   
3. **VPNエンドポイントのステータスを確認**
   - インフラ管理者にVPNエンドポイントが正常稼働しているか確認

### 問題3: 接続後にインターネットにアクセスできない

**症状**: VPN接続は成功するが、Webサイトにアクセスできない

**解決方法**:
1. **DNSを確認**
   - スマホの設定でDNSが正しく設定されているか確認
   
2. **VPN接続を再確立**
   - VPN接続を切断して再接続
   
3. **Split Tunnelを確認**
   - インフラ管理者にSplit Tunnel設定を確認

### 問題4: 「Certificate expired」エラー

**症状**: 証明書の有効期限切れエラーが表示される

**解決方法**:
1. **証明書の有効期限を確認**
   - インフラ管理者に証明書の有効期限を確認
   
2. **新しい証明書を取得**
   - インフラ管理者から新しい証明書を取得
   - 古い証明書を削除して新しい証明書をインポート

### 問題5: バッテリーの消費が激しい

**症状**: VPN接続中にバッテリーが急速に減る

**解決方法**:
1. **自動接続を無効にする**
   - 必要な時だけVPN接続を使用
   
2. **Split Tunnelを有効にする**
   - インフラ管理者にSplit Tunnel設定を依頼
   - 必要なトラフィックのみVPN経由にする
   
3. **バックグラウンドアプリを制限**
   - VPN接続中は不要なアプリを終了

### 問題6: 「VPN configuration error」エラー

**症状**: VPN構成エラーが表示される

**解決方法**:
1. **プロファイルを削除して再作成**
   - AWS VPN Clientでプロファイルを削除
   - `.ovpn`ファイルを再インポート
   
2. **設定ファイルを再取得**
   - インフラ管理者から最新の`.ovpn`ファイルを取得
   
3. **アプリを再インストール**
   - AWS VPN Clientをアンインストール
   - App Store/Google Play Storeから再インストール

## セキュリティのベストプラクティス

### 証明書の管理

- ✅ **安全な保管**: 証明書ファイルはスマホ内に安全に保管
- ✅ **定期的な更新**: 証明書の有効期限前に更新
- ⚠️ **共有禁止**: 証明書を他人と共有しない
- ⚠️ **紛失時の対応**: スマホを紛失した場合は、すぐにインフラ管理者に連絡して証明書を失効

### 接続時の注意事項

- ✅ **公共Wi-Fiでの使用**: VPN接続により通信が暗号化されるため、公共Wi-Fiでも安全に使用できます
- ✅ **自動切断**: 長時間使用しない場合は、VPN接続を切断してバッテリーを節約
- ⚠️ **画面ロック**: スマホに画面ロック（パスコード、指紋認証、顔認証）を設定

### セッション管理

- VPN接続は**12時間**で自動的に切断されます
- 再接続時は、証明書認証が自動的に行われます（MFA不要）

## サポート

問題が解決しない場合は、以下の情報を添えてインフラチームに連絡してください：

### 必要な情報

1. **エラーメッセージ**: スクリーンショット
2. **デバイス情報**: iPhone/Android、OSバージョン
3. **AWS VPN Clientバージョン**: 設定→バージョン情報
4. **証明書情報**: 証明書の有効期限、発行日

### 連絡先

- **インフラチーム**: infrastructure@example.com
- **ヘルプデスク**: helpdesk@example.com

---

**作成日**: 2024年
**最終更新**: 2024年
**バージョン**: 1.0.0
